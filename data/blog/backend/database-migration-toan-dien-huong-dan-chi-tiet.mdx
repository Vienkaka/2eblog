---
title: 'Database Migration To√†n Di·ªán - H∆∞·ªõng D·∫´n Chi Ti·∫øt'
date: '2024-01-20'
lastmod: '2024-01-20'
tags: ['database', 'migration', 'backend', 'devops', 'sql', 'best-practices']
draft: false
summary: 'H∆∞·ªõng d·∫´n to√†n di·ªán v·ªÅ Database Migration - t·ª´ kh√°i ni·ªám c∆° b·∫£n ƒë·∫øn c√°c th·ª±c h√†nh t·ªët nh·∫•t, c√¥ng c·ª• ph·ªï bi·∫øn v√† chi·∫øn l∆∞·ª£c tri·ªÉn khai an to√†n.'
images:
  [
    'https://fastly.picsum.photos/id/25/5000/3333.jpg?hmac=yCz9LeSs-i72Ru0YvvpsoECnCTxZjzGde805gWrAHkM',
  ]
authors: ['default']
layout: PostLayout
canonicalUrl: https://gaoden.vercel.app/blog/backend/database-migration-toan-dien-huong-dan-chi-tiet
---

## Gi·ªõi thi·ªáu

**Database Migration** l√† qu√° tr√¨nh qu·∫£n l√Ω v√† √°p d·ª•ng c√°c thay ƒë·ªïi trong c·∫•u tr√∫c c∆° s·ªü d·ªØ li·ªáu m·ªôt c√°ch c√≥ h·ªá th·ªëng v√† an to√†n. ƒê√¢y l√† m·ªôt ph·∫ßn kh√¥ng th·ªÉ thi·∫øu trong qu√° tr√¨nh ph√°t tri·ªÉn ph·∫ßn m·ªÅm hi·ªán ƒë·∫°i, ƒë·∫∑c bi·ªát khi √°p d·ª•ng **DevOps** v√† **CI/CD**.

Trong b√†i vi·∫øt n√†y, ch√∫ng ta s·∫Ω t√¨m hi·ªÉu to√†n di·ªán v·ªÅ Database Migration

## Database Migration l√† g√¨?

**Database Migration** bao g·ªìm vi·ªác:

- T·∫°o, s·ª≠a ƒë·ªïi ho·∫∑c x√≥a c√°c b·∫£ng, c·ªôt, ch·ªâ m·ª•c
- Thay ƒë·ªïi ki·ªÉu d·ªØ li·ªáu v√† r√†ng bu·ªôc
- C·∫≠p nh·∫≠t d·ªØ li·ªáu hi·ªán c√≥
- T·∫°o ho·∫∑c x√≥a stored procedures, functions, triggers
- Qu·∫£n l√Ω quy·ªÅn truy c·∫≠p v√† b·∫£o m·∫≠t

### V√≠ d·ª• Migration c∆° b·∫£n

```sql
-- Migration: Th√™m c·ªôt email v√†o b·∫£ng users
-- Up Migration
ALTER TABLE users ADD COLUMN email VARCHAR(255) UNIQUE;

-- Down Migration (Rollback)
ALTER TABLE users DROP COLUMN email;
```

## T·∫°i sao Database Migration c·∫ßn thi·∫øt?

### 1. **Qu·∫£n l√Ω phi√™n b·∫£n c∆° s·ªü d·ªØ li·ªáu**

Gi·ªëng nh∆∞ m√£ ngu·ªìn, c∆° s·ªü d·ªØ li·ªáu c≈©ng c·∫ßn ƒë∆∞·ª£c qu·∫£n l√Ω phi√™n b·∫£n:

```bash
# C·∫•u tr√∫c th∆∞ m·ª•c migration
migrations/
‚îú‚îÄ‚îÄ 001_create_users_table.sql
‚îú‚îÄ‚îÄ 002_add_email_to_users.sql
‚îú‚îÄ‚îÄ 003_create_posts_table.sql
‚îî‚îÄ‚îÄ 004_add_indexes.sql
```

### 2. **H·ªó tr·ª£ CI/CD v√† Tri·ªÉn khai li√™n t·ª•c**

Migration cho ph√©p t·ª± ƒë·ªông h√≥a qu√° tr√¨nh tri·ªÉn khai:

```yaml
# .github/workflows/deploy.yml
- name: Run Database Migrations
  run: |
    flyway migrate
    flyway info
```

### 3. **Ph√°t tri·ªÉn nh√≥m hi·ªáu qu·∫£**

- ƒê·ªìng b·ªô h√≥a c·∫•u tr√∫c DB gi·ªØa c√°c m√¥i tr∆∞·ªùng
- Tr√°nh xung ƒë·ªôt khi nhi·ªÅu dev l√†m vi·ªác c√πng l√∫c
- ƒê·∫£m b·∫£o t√≠nh nh·∫•t qu√°n gi·ªØa dev, staging, production

### 4. **Kh·∫£ nƒÉng Rollback**

```sql
-- Rollback migration
BEGIN;
-- Th·ª±c hi·ªán c√°c thay ƒë·ªïi ng∆∞·ª£c l·∫°i
ALTER TABLE users DROP COLUMN phone;
COMMIT;
```

## C√°c lo·∫°i Database Migration

### 1. **Schema Migration**

Thay ƒë·ªïi c·∫•u tr√∫c c∆° s·ªü d·ªØ li·ªáu:

```sql
-- T·∫°o b·∫£ng m·ªõi
CREATE TABLE posts (
    id SERIAL PRIMARY KEY,
    title VARCHAR(255) NOT NULL,
    content TEXT,
    user_id INTEGER REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Th√™m ch·ªâ m·ª•c
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_created_at ON posts(created_at);
```

### 2. **Data Migration**

Chuy·ªÉn ƒë·ªïi ho·∫∑c c·∫≠p nh·∫≠t d·ªØ li·ªáu:

```sql
-- C·∫≠p nh·∫≠t d·ªØ li·ªáu hi·ªán c√≥
UPDATE users
SET status = 'active'
WHERE status IS NULL;

-- Chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu
UPDATE posts
SET published_at = created_at
WHERE published = true;
```

### 3. **Seed Migration**

Th√™m d·ªØ li·ªáu kh·ªüi t·∫°o:

```sql
-- Th√™m d·ªØ li·ªáu m·∫´u
INSERT INTO categories (name, slug) VALUES
('Technology', 'technology'),
('Programming', 'programming'),
('Web Development', 'web-development');
```

## C√°c c√¥ng c·ª• ph·ªï bi·∫øn

### 1. **Flyway**

**Flyway** l√† c√¥ng c·ª• m√£ ngu·ªìn m·ªü ph·ªï bi·∫øn nh·∫•t:

```xml
<!-- flyway.conf -->
flyway.url=jdbc:postgresql://localhost:5432/mydb
flyway.user=myuser
flyway.password=mypassword
flyway.locations=filesystem:db/migration
flyway.baselineOnMigrate=true
```

**ƒê·∫∑t t√™n file migration:**

```
V1__Create_users_table.sql
V2__Add_email_to_users.sql
V3__Create_posts_table.sql
```

### 2. **Liquibase**

H·ªó tr·ª£ nhi·ªÅu ƒë·ªãnh d·∫°ng (XML, YAML, JSON):

```xml
<!-- changelog.xml -->
<changeSet id="1" author="developer">
    <createTable tableName="users">
        <column name="id" type="int" autoIncrement="true">
            <constraints primaryKey="true"/>
        </column>
        <column name="username" type="varchar(50)">
            <constraints nullable="false" unique="true"/>
        </column>
        <column name="email" type="varchar(100)">
            <constraints nullable="false" unique="true"/>
        </column>
    </createTable>
</changeSet>
```

### 3. **Sequelize (Node.js)**

```javascript
// migrations/20240120-create-users.js
module.exports = {
  up: async (queryInterface, Sequelize) => {
    await queryInterface.createTable('users', {
      id: {
        allowNull: false,
        autoIncrement: true,
        primaryKey: true,
        type: Sequelize.INTEGER,
      },
      username: {
        type: Sequelize.STRING,
        allowNull: false,
        unique: true,
      },
      email: {
        type: Sequelize.STRING,
        allowNull: false,
        unique: true,
      },
      createdAt: {
        allowNull: false,
        type: Sequelize.DATE,
      },
      updatedAt: {
        allowNull: false,
        type: Sequelize.DATE,
      },
    })
  },
  down: async (queryInterface, Sequelize) => {
    await queryInterface.dropTable('users')
  },
}
```

### 4. **Django Migrations (Python)**

```python
# models.py
from django.db import models

class User(models.Model):
    username = models.CharField(max_length=50, unique=True)
    email = models.EmailField(unique=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

# T·∫°o migration
# python manage.py makemigrations
# python manage.py migrate
```

## Best Practices cho Database Migration

### 1. **ƒê·∫∑t t√™n file migration r√µ r√†ng**

```bash
# ‚úÖ T·ªët
20240120_001_create_users_table.sql
20240120_002_add_email_to_users.sql
20240120_003_create_posts_table.sql

# ‚ùå Tr√°nh
migration1.sql
update.sql
fix.sql
```

### 2. **Vi·∫øt migration c√≥ th·ªÉ rollback**

```sql
-- ‚úÖ Migration an to√†n
BEGIN;

-- Up migration
ALTER TABLE users ADD COLUMN phone VARCHAR(20);

-- Down migration (ƒë∆∞·ª£c l∆∞u ri√™ng)
-- ALTER TABLE users DROP COLUMN phone;

COMMIT;
```

### 3. **Test migration tr√™n m√¥i tr∆∞·ªùng dev tr∆∞·ªõc**

```bash
# Test migration
flyway migrate -url=jdbc:postgresql://localhost:5432/testdb
flyway validate
```

### 4. **Backup tr∆∞·ªõc khi ch·∫°y migration production**

```bash
# PostgreSQL backup
pg_dump mydb > backup_$(date +%Y%m%d_%H%M%S).sql

# MySQL backup
mysqldump -u username -p mydb > backup_$(date +%Y%m%d_%H%M%S).sql
```

### 5. **S·ª≠ d·ª•ng transaction khi c√≥ th·ªÉ**

```sql
BEGIN;
-- T·∫•t c·∫£ migration commands
ALTER TABLE users ADD COLUMN phone VARCHAR(20);
CREATE INDEX idx_users_phone ON users(phone);
COMMIT;
```

### 6. **Tr√°nh thay ƒë·ªïi ph√° h·ªßy**

```sql
-- ‚ùå Tr√°nh: X√≥a c·ªôt ngay l·∫≠p t·ª©c
ALTER TABLE users DROP COLUMN old_column;

-- ‚úÖ T·ªët: Quy tr√¨nh an to√†n
-- B∆∞·ªõc 1: Th√™m c·ªôt m·ªõi
ALTER TABLE users ADD COLUMN new_column VARCHAR(255);

-- B∆∞·ªõc 2: Copy d·ªØ li·ªáu
UPDATE users SET new_column = old_column;

-- B∆∞·ªõc 3: X√≥a c·ªôt c≈© (trong migration sau)
-- ALTER TABLE users DROP COLUMN old_column;
```

## Chi·∫øn l∆∞·ª£c tri·ªÉn khai Migration

### 1. **Blue-Green Deployment**

```bash
# Blue environment (hi·ªán t·∫°i)
# Green environment (m·ªõi)
# Chuy·ªÉn ƒë·ªïi traffic sau khi migration ho√†n t·∫•t
```

### 2. **Zero-Downtime Migration**

```sql
-- B∆∞·ªõc 1: Th√™m c·ªôt nullable
ALTER TABLE users ADD COLUMN new_email VARCHAR(255);

-- B∆∞·ªõc 2: Copy d·ªØ li·ªáu (background job)
UPDATE users SET new_email = email WHERE new_email IS NULL;

-- B∆∞·ªõc 3: Th√™m constraint
ALTER TABLE users ALTER COLUMN new_email SET NOT NULL;

-- B∆∞·ªõc 4: X√≥a c·ªôt c≈© (trong deployment sau)
```

### 3. **Feature Flags**

```javascript
// S·ª≠ d·ª•ng feature flag ƒë·ªÉ ki·ªÉm so√°t migration
if (featureFlags.isNewSchemaEnabled()) {
  // S·ª≠ d·ª•ng schema m·ªõi
  const users = await UserV2.findAll()
} else {
  // S·ª≠ d·ª•ng schema c≈©
  const users = await User.findAll()
}
```

## Monitoring v√† Logging

### 1. **Theo d√µi Migration Status**

```sql
-- T·∫°o b·∫£ng tracking
CREATE TABLE migration_log (
    id SERIAL PRIMARY KEY,
    migration_name VARCHAR(255) NOT NULL,
    executed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    execution_time_ms INTEGER,
    status VARCHAR(50) NOT NULL
);
```

### 2. **Logging chi ti·∫øt**

```javascript
// Log migration progress
console.log(`Starting migration: ${migrationName}`)
const startTime = Date.now()

try {
  await runMigration()
  const duration = Date.now() - startTime
  console.log(`Migration completed in ${duration}ms`)
} catch (error) {
  console.error(`Migration failed: ${error.message}`)
  throw error
}
```

## Troubleshooting Migration

### 1. **Migration b·ªã stuck**

```sql
-- Ki·ªÉm tra locks
SELECT * FROM pg_locks WHERE relation = 'users'::regclass;

-- Kill long-running queries
SELECT pg_terminate_backend(pid) FROM pg_stat_activity
WHERE query LIKE '%ALTER TABLE users%';
```

### 2. **Rollback migration**

```bash
# Flyway rollback
flyway undo

# Liquibase rollback
liquibase rollback-count 1
```

### 3. **Ki·ªÉm tra migration status**

```bash
# Flyway info
flyway info

# Sequelize status
npx sequelize-cli db:migrate:status
```

## K·∫øt lu·∫≠n

Database Migration l√† m·ªôt k·ªπ nƒÉng quan tr·ªçng trong ph√°t tri·ªÉn ph·∫ßn m·ªÅm hi·ªán ƒë·∫°i. Vi·ªác √°p d·ª•ng ƒë√∫ng c√°c th·ª±c h√†nh t·ªët s·∫Ω gi√∫p:

- **ƒê·∫£m b·∫£o t√≠nh to√†n v·∫πn d·ªØ li·ªáu**
- **H·ªó tr·ª£ CI/CD pipeline**
- **Gi·∫£m thi·ªÉu r·ªßi ro khi tri·ªÉn khai**
- **TƒÉng hi·ªáu qu·∫£ l√†m vi·ªác nh√≥m**

### T√†i li·ªáu tham kh·∫£o

- [Flyway Documentation](https://flywaydb.org/documentation/)
- [Liquibase Documentation](https://docs.liquibase.com/)
- [Sequelize Migrations](https://sequelize.org/docs/v6/other-topics/migrations/)

B·∫°n c√≥ kinh nghi·ªám g√¨ v·ªÅ Database Migration kh√¥ng? H√£y chia s·∫ª trong ph·∫ßn comment nh√©! üöÄ
